#!/usr/bin/env perl

use warnings;
use strict;

use FindBin;
use lib
    "$FindBin::Bin/../lib",
;

use YAML qw( LoadFile );
use File::ChangeNotify;
use Path::Class::File;

use Plerd;

my $config_ref = LoadFile( "$FindBin::Bin/../conf/plerd.conf" );

my $plerd = Plerd->new(
    path         => $config_ref->{ path },
    title        => $config_ref->{ title },
    author_name  => $config_ref->{ author_name },
    author_email => $config_ref->{ author_email },
    base_uri     => URI->new ( $config_ref->{ base_uri } ),
);

my $watcher = File::ChangeNotify->instantiate_watcher (
    directories => [ $plerd->source_directory . '' ],
    filter      => qr/\.(md|markdown)$/,
);

warn "Plerdwatcher is watching " . $plerd->source_directory . "...\n";

while ( my @events = $watcher->wait_for_events ) {
    if ( @events ) {
        $plerd->publish_all;
    }
}

=head1 NAME

plerdall - Publish an entire Plerd blog from source

=head1 SYNOPSIS

In /path/to/plerd/conf/plerd.conf:

 base_uri: http://blog.example.com
 path: /home/me/Dropbox/plerd
 title: My Lovely Blog

And then, on the command line, while in the top-level plerd directory:

 bin/plerdwatcher &

=head1 DESCRIPTION

This script launches a simple daemon that monitors a Plerd blog's Dropbox-
synced directory for changes. When it sees changes, it will direct Plerd
to publish or republish files as needed.

For instructions on installing and using Plerd, please see the README file that
should have accompanied this distribution. It is also available online
at L<https://github.com/jmacdotorg/plerd#plerd>.

=head1 AUTHOR

Jason McIntosh <jmac@jmac.org>
